#!/bin/bash
export KNITTY=True

_ipynb=()
if [[ "${out_ext}" == "ipynb" ]]; then
    _ipynb=("--to-ipynb"); fi

cat |
pre-knitty "${input_file}" --yaml "$metadata" |
pre-sugartex |
cat-md stdin "$metadata" "${extra_inputs[@]}" |
pandoc "${reader_args[@]}" -t json |
knitty "${input_file}" "${reader_args[@]}" "${writer_args[@]}" "${_ipynb[@]}" |
panfl "${panfl_args[@]}" |
pandoc-crossref "$t" |
pandoc -f json "${writer_args[@]}" |
if [[ "${out_ext}" == "ipynb" ]]; then
    post-knitty --to-ipynb |
    jupyter nbconvert "${nbconvert_args[@]}"
elif [[ "$to" == "html" && "${out_ext}" == "pdf" ]]; then
    pyppdf-replace-mathjax "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js" |
    pyppdf -o "${output_file}" --goto temp
elif [[ "${to:0:4}" == "html" ]]; then
    pyppdf-replace-mathjax
else
    cat; fi

if [[ -d "$tmpdir" ]]; then rm -rf "$tmpdir"; fi
